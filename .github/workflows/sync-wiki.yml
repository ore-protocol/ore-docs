name: Auto-Sync Repository to Wiki

on:
  push:
    branches: [main]
    paths: ['docs/**', 'WIKI_HOME.md', 'README.md']
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±°ë„ ê°€ëŠ¥

permissions:
  contents: write

jobs:
  sync-to-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git Config
        run: |
          git config --global user.name "ORE Documentation Bot"
          git config --global user.email "docs@ore-protocol.com"

      - name: Clone or Update Wiki
        run: |
          echo "ðŸ“š Cloning wiki repository..."
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git wiki-repo || {
            echo "Clone failed, trying alternative method..."
            mkdir -p wiki-repo
            cd wiki-repo
            git init
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git
            git fetch origin
            git checkout master || git checkout main || git checkout -b master
            cd ..
          }
          
          # Wiki ë””ë ‰í† ë¦¬ í™•ì¸
          if [ -d "wiki-repo" ]; then
            echo "âœ… Wiki directory exists"
            cd wiki-repo
            
            # í˜„ìž¬ ë¸Œëžœì¹˜ í™•ì¸
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "none")
            echo "Current branch: $CURRENT_BRANCH"
            
            # Pull latest changes
            git pull origin $CURRENT_BRANCH || echo "Pull failed or no remote branch"
            
            cd ..
          else
            echo "âŒ Failed to create wiki directory"
            exit 1
          fi

      - name: Clean Wiki Content
        run: |
          echo "ðŸ§¹ Cleaning old wiki content..."
          cd wiki-repo
          # Git ì¶”ì  íŒŒì¼ë§Œ ì‚­ì œ (Home.md ì œì™¸)
          git ls-files '*.md' | grep -v '^Home.md$' | xargs -r rm -f
          cd ..

      - name: Copy Documentation Files
        run: |
          echo "ðŸ“„ Copying documentation files..."
          
          # Home íŽ˜ì´ì§€
          if [ -f "WIKI_HOME.md" ]; then
            echo "Copying WIKI_HOME.md to Home.md"
            cp WIKI_HOME.md wiki-repo/Home.md
          elif [ -f "README.md" ]; then
            echo "WIKI_HOME.md not found, using README.md"
            cp README.md wiki-repo/Home.md
          fi
          
          # ê° ë””ë ‰í† ë¦¬ë³„ë¡œ íŒŒì¼ ë³µì‚¬
          echo "ðŸ“ Copying business documents..."
          for file in docs/business/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              # íŒŒì¼ëª… ë³€í™˜ (snake_case to Title-Case)
              newname=$(echo "$filename" | sed 's/_/-/g' | sed 's/\b\(.\)/\u\1/g')
              echo "  - $filename â†’ $newname"
              cp "$file" "wiki-repo/$newname.md"
            fi
          done
          
          echo "ðŸ“ Copying technical documents..."
          for file in docs/technical/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              newname=$(echo "$filename" | sed 's/_/-/g' | sed 's/\b\(.\)/\u\1/g')
              echo "  - $filename â†’ $newname"
              cp "$file" "wiki-repo/$newname.md"
            fi
          done
          
          echo "ðŸ“ Copying game-design documents..."
          for file in docs/game-design/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              newname=$(echo "$filename" | sed 's/_/-/g' | sed 's/\b\(.\)/\u\1/g')
              echo "  - $filename â†’ $newname"
              cp "$file" "wiki-repo/$newname.md"
            fi
          done
          
          echo "ðŸ“ Copying operations documents..."
          for file in docs/operations/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              newname=$(echo "$filename" | sed 's/_/-/g' | sed 's/\b\(.\)/\u\1/g')
              echo "  - $filename â†’ $newname"
              cp "$file" "wiki-repo/$newname.md"
            fi
          done
          
          echo "ðŸ“ Copying AI guides..."
          for file in docs/ai-guides/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              newname=$(echo "$filename" | sed 's/_/-/g' | sed 's/\b\(.\)/\u\1/g')
              echo "  - $filename â†’ $newname"
              cp "$file" "wiki-repo/$newname.md"
            fi
          done

      - name: Generate Sidebar
        run: |
          echo "ðŸ“ Generating sidebar..."
          cat > wiki-repo/_Sidebar.md << 'EOF'
          ## ðŸ  [Home](Home)
          
          ## ðŸ¢ Business & Strategy
          - [Business Plan](Business-Plan)
          - [MVP Definition](Mvp-Definition)
          - [Executive Brief](Executive-Brief)
          - [Branding Guide](Branding-Guide)
          - [AI Team Strategy](Ai-Team-Strategy)
          - [Development Roadmap](Development-Roadmap)
          
          ## ðŸ”§ Technical Specs
          - [Backend Spec](Backend-Spec)
          - [Frontend Spec](Frontend-Spec)
          - [Infrastructure Spec](Infrastructure-Spec)
          - [API Documentation Strategy](Api-Documentation-Strategy)
          
          ## ðŸŽ® Game Design
          - [Gameplay Spec](Game-Play-Spec)
          - [Player Journey Map](Player-Journey-Map)
          - [Game Worldview](Game-Worldview)
          - [UX Guide](Ux-Guide)
          
          ## ðŸš€ Operations
          - [Operations Roadmap](Operations-Roadmap)
          - [Mystery Campaign](Mystery-Campaign)
          - [Genesis Operations](Genesis-Operations)
          - [Live Ops Playbook](Live-Ops-Playbook)
          
          ## ðŸ¤– AI Guides
          - [Backend AI Guide](Backend-Ai-Guide)
          - [Frontend AI Guide](Frontend-Ai-Guide)
          - [Infrastructure AI Guide](Infrastructure-Ai-Guide)
          
          ---
          
          ## ðŸ”— Quick Links
          - ðŸ“Š [Project Board](https://github.com/orgs/ore-protocol/projects/1)
          - ðŸ—ï¸ [Main Code](https://github.com/ore-protocol/ore-platform)
          - ðŸ’¬ Discord (Coming Soon)
          
          *"Between the zeros and ones"*
          EOF

      - name: Commit and Push Changes
        run: |
          cd wiki-repo
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          git add -A
          
          if git diff --staged --quiet; then
            echo "ðŸ“ No changes to commit"
          else
            echo "ðŸ“¤ Pushing changes to wiki..."
            git commit -m "ðŸ“š Auto-sync from repository ($(date '+%Y-%m-%d %H:%M'))"
            
            # Push ì‹œë„
            git push origin HEAD:master || \
            git push origin HEAD:main || \
            git push origin HEAD || {
              echo "âŒ Failed to push changes"
              echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
              echo "Remote branches:"
              git branch -r
              exit 1
            }
            
            echo "âœ… Wiki updated successfully!"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ðŸ“Š Sync Summary:"
          echo "Repository: ${{ github.repository }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Commit: ${{ github.sha }}"
          if [ -d "wiki-repo" ]; then
            echo "Files in wiki:"
            ls -la wiki-repo/*.md 2>/dev/null || echo "No markdown files"
          fi
